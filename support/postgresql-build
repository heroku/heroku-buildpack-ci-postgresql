set -e

if [ ! -f "/var/cache/postgresql-$POSTGRESQL_VERSION.tar.gz" ]; then
  wget -q -O /var/cache/postgresql-$POSTGRESQL_VERSION.tar.gz http://ftp.postgresql.org/pub/source/v${POSTGRESQL_VERSION}/postgresql-${POSTGRESQL_VERSION}.tar.gz
fi

cd /var/cache/

tar zxf /var/cache/postgresql-$POSTGRESQL_VERSION.tar.gz

cd postgresql-$POSTGRESQL_VERSION

LDFLAGS='-Wl,--as-needed -Wl,-z,now'
CFLAGS='-fPIC -DLINUX_OOM_ADJ=0'

apt-get install uuid-dev

./configure --prefix=/app/vendor/postgresql \
            --enable-integer-datetimes \
            --enable-thread-safety \
            --enable-debug \
            --disable-rpath \
            --with-gnu-ld \
            --with-pgport=5432 \
            --with-system-tzdata=/usr/share/zoneinfo \
            --without-tcl \
            --without-perl \
            --without-python \
            --with-krb5 \
            --with-gssapi \
            --with-openssl \
            --with-libxml \
            --with-libxslt \
            --with-uuid=e2fs \
            --with-address_standardizer \
            --with-address_standardizer_data_us \
            --with-autoinc \
            --with-btree_gist \
            --with-btree_gin \
            --with-chkpass \
            --with-citext \
            --with-cube \
            --with-dblink \
            --with-dict_int \
            --with-earthdistance \
            --with-fuzzystrmatch \
            --with-hstore \
            --with-insert_username \
            --with-intarray \
            --with-isn \
            --with-lo \
            --with-ltree \
            --with-moddatetime \
            --with-pg_stat_statements \
            --with-pg_trgm \
            --with-pgcrypto \
            --with-pgrowlocks \
            --with-pgstattuple \
            --with-plpgsql \
            --with-refint \
            --with-seg \
            --with-sslinfo \
            --with-tablefunc \
            --with-tcn \
            --with-timetravel \
            --with-unaccent \
            --with-uuid-ossp \
            --with-xml2

make
make install

cd contrib
make
make install

cd /app/vendor/postgresql
tar -zcf - . | /gof3r put -b $S3_BUCKET -k cedar-14/postgresql-$POSTGRESQL_VERSION.tgz --acl public-read
